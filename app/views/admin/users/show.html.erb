<% content_for(:title) { "#{@user.full_name} - Admin - Family Hub" } %>

<div class="max-w-4xl mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex items-center gap-3 mb-6">
    <%= link_to admin_users_path, class: "p-2 -ml-2 text-theme-secondary hover:text-theme-text hover:bg-theme-surface rounded-lg transition-colors" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    <% end %>
    <h1 class="text-2xl font-bold text-theme-text">User Details</h1>
  </div>

  <!-- User Profile Card -->
  <div class="card p-6 mb-6">
    <div class="flex items-start gap-6">
      <!-- Avatar -->
      <div class="flex-shrink-0">
        <% if @user.avatar.attached? %>
          <%= image_tag @user.avatar, class: "w-24 h-24 rounded-full object-cover" %>
        <% else %>
          <div class="w-24 h-24 rounded-full bg-theme-primary/20 flex items-center justify-center">
            <span class="text-theme-primary text-3xl font-medium"><%= @user.initials %></span>
          </div>
        <% end %>
      </div>

      <!-- User Info -->
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-2">
          <h2 class="text-xl font-semibold text-theme-text"><%= @user.full_name %></h2>
          <% if @user.admin? %>
            <span class="badge badge-primary">Admin</span>
          <% else %>
            <span class="badge badge-secondary">Member</span>
          <% end %>
          <% case @user.status %>
          <% when 'active' %>
            <span class="badge bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">Active</span>
          <% when 'inactive' %>
            <span class="badge bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400">Inactive</span>
          <% when 'removed' %>
            <span class="badge bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">Removed</span>
          <% end %>
        </div>

        <p class="text-theme-secondary mb-4"><%= @user.email %></p>

        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span class="text-theme-secondary">City:</span>
            <span class="text-theme-text ml-2"><%= @user.city %></span>
          </div>
          <div>
            <span class="text-theme-secondary">Date of Birth:</span>
            <span class="text-theme-text ml-2"><%= @user.date_of_birth.strftime("%B %d, %Y") %></span>
          </div>
          <div>
            <span class="text-theme-secondary">Joined:</span>
            <span class="text-theme-text ml-2"><%= @user.created_at.strftime("%B %d, %Y") %></span>
          </div>
          <div>
            <span class="text-theme-secondary">Password Changed:</span>
            <span class="text-theme-text ml-2"><%= @user.password_changed? ? 'Yes' : 'No (using temp password)' %></span>
          </div>
        </div>
      </div>

      <!-- Edit Button -->
      <%= link_to edit_admin_user_path(@user), class: "btn btn-secondary" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
        Edit
      <% end %>
    </div>
  </div>

  <!-- Notification Preferences -->
  <div class="card p-6 mb-6">
    <h3 class="text-lg font-semibold text-theme-text mb-4">Notification Preferences</h3>
    <div class="grid grid-cols-3 gap-4 text-sm">
      <div class="flex items-center gap-2">
        <% if @user.notify_in_app %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        <% else %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-theme-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        <% end %>
        <span class="text-theme-text">In-App Notifications</span>
      </div>
      <div class="flex items-center gap-2">
        <% if @user.notify_email %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        <% else %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-theme-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        <% end %>
        <span class="text-theme-text">Email Notifications</span>
      </div>
      <div class="flex items-center gap-2">
        <% if @user.notify_push %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        <% else %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-theme-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        <% end %>
        <span class="text-theme-text">Push Notifications</span>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="card p-6">
    <h3 class="text-lg font-semibold text-theme-text mb-4">Actions</h3>

    <div class="flex flex-wrap gap-3">
      <!-- Status Actions -->
      <% if @user.active? %>
        <%# Deactivate button - opens modal %>
        <button type="button"
                data-action="click->modal#open"
                data-modal-id="confirm-deactivate"
                class="btn btn-secondary"
                onclick="document.getElementById('confirm-deactivate').querySelector('[data-controller=modal]').dispatchEvent(new CustomEvent('modal:open'))">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
          </svg>
          Deactivate
        </button>
      <% else %>
        <%= button_to activate_admin_user_path(@user),
            method: :post,
            class: "btn btn-primary" do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Activate
        <% end %>
      <% end %>

      <!-- Role Actions -->
      <% if @user.admin? %>
        <% unless @user == current_user %>
          <%# Make Member button - opens modal %>
          <button type="button"
                  class="btn btn-secondary"
                  onclick="document.getElementById('confirm-make-member').querySelector('[data-controller=modal]').dispatchEvent(new CustomEvent('modal:open'))">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            Make Member
          </button>
        <% end %>
      <% else %>
        <%# Make Admin button - opens modal %>
        <button type="button"
                class="btn btn-secondary"
                onclick="document.getElementById('confirm-make-admin').querySelector('[data-controller=modal]').dispatchEvent(new CustomEvent('modal:open'))">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
          Make Admin
        </button>
      <% end %>

      <!-- Reset Password Action -->
      <% if @user != current_user %>
        <button type="button"
                class="btn btn-secondary"
                onclick="document.getElementById('confirm-reset-password').querySelector('[data-controller=modal]').dispatchEvent(new CustomEvent('modal:open'))">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
          </svg>
          Reset Password
        </button>
      <% end %>

      <!-- Remove Action -->
      <% if @user.status != 'removed' && @user != current_user %>
        <button type="button"
                class="btn bg-red-600 hover:bg-red-700 text-white"
                onclick="document.getElementById('confirm-remove').querySelector('[data-controller=modal]').dispatchEvent(new CustomEvent('modal:open'))">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Remove User
        </button>
      <% end %>
    </div>

    <% if @user == current_user %>
      <p class="text-sm text-theme-secondary mt-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Some actions are disabled because this is your own account.
      </p>
    <% end %>
  </div>
</div>

<%# Confirmation Modals %>

<%# Deactivate User %>
<% if @user.active? %>
  <div id="confirm-deactivate">
    <%= render "shared/confirm_dialog",
        id: "deactivate-modal",
        title: "Deactivate User",
        message: "Are you sure you want to deactivate #{@user.full_name}? They won't be able to log in until reactivated.",
        icon: "warning",
        confirm_text: "Deactivate",
        confirm_style: "danger",
        form_action: deactivate_admin_user_path(@user),
        form_method: :post %>
  </div>
<% end %>

<%# Make Member %>
<% if @user.admin? && @user != current_user %>
  <div id="confirm-make-member">
    <%= render "shared/confirm_dialog",
        id: "make-member-modal",
        title: "Remove Admin Privileges",
        message: "Are you sure you want to remove admin privileges from #{@user.full_name}? They will become a regular member.",
        icon: "warning",
        confirm_text: "Make Member",
        confirm_style: "primary",
        form_action: make_member_admin_user_path(@user),
        form_method: :post %>
  </div>
<% end %>

<%# Make Admin %>
<% unless @user.admin? %>
  <div id="confirm-make-admin">
    <%= render "shared/confirm_dialog",
        id: "make-admin-modal",
        title: "Grant Admin Privileges",
        message: "Are you sure you want to grant admin privileges to #{@user.full_name}? They will have full access to manage users and settings.",
        icon: "info",
        confirm_text: "Make Admin",
        confirm_style: "primary",
        form_action: make_admin_admin_user_path(@user),
        form_method: :post %>
  </div>
<% end %>

<%# Reset Password %>
<% if @user != current_user %>
  <div id="confirm-reset-password">
    <%= render "shared/confirm_dialog",
        id: "reset-password-modal",
        title: "Reset Password",
        message: "This will generate a new temporary password for #{@user.full_name}. Their current password will stop working immediately. You'll need to share the new password with them.",
        icon: "warning",
        confirm_text: "Reset Password",
        confirm_style: "primary",
        form_action: reset_password_admin_user_path(@user),
        form_method: :post %>
  </div>
<% end %>

<%# Remove User %>
<% if @user.status != 'removed' && @user != current_user %>
  <div id="confirm-remove">
    <%= render "shared/confirm_dialog",
        id: "remove-modal",
        title: "Remove User",
        message: "Are you sure you want to remove #{@user.full_name}? They will no longer be able to access the app. This action can be reversed by reactivating the user.",
        icon: "danger",
        confirm_text: "Remove User",
        confirm_style: "danger",
        form_action: remove_admin_user_path(@user),
        form_method: :post %>
  </div>
<% end %>
