<% content_for(:title) { "Edit Profile - Family Hub" } %>

<div class="max-w-2xl mx-auto px-4 py-8">
  <div class="flex items-center gap-3 mb-6">
    <%= link_to profile_path, class: "p-2 -ml-2 text-theme-secondary hover:text-theme-text hover:bg-theme-surface rounded-[15px] transition-colors" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    <% end %>
    <h1 class="text-2xl font-bold text-theme-text">Edit Profile</h1>
  </div>

  <%= form_with model: @user, url: profile_path, method: :patch, class: "space-y-6" do |f| %>
    <!-- Avatar Upload -->
    <div class="card p-6">
      <h2 class="text-lg font-semibold text-theme-text mb-4">Avatar</h2>
      <div class="flex items-center gap-4">
        <div class="w-20 h-20 rounded-full overflow-hidden bg-theme-surface">
          <% if @user.avatar.attached? %>
            <%= image_tag @user.avatar, class: "w-full h-full object-cover", alt: @user.full_name %>
          <% else %>
            <div class="w-full h-full flex items-center justify-center text-2xl font-bold text-theme-text/50">
              <%= @user.initials %>
            </div>
          <% end %>
        </div>
        <div class="flex-1">
          <%= f.file_field :avatar, accept: "image/*", class: "input", direct_upload: true %>
          <p class="text-xs text-theme-secondary mt-1">PNG, JPG or GIF. Max 5MB.</p>
        </div>
      </div>
    </div>

    <!-- Basic Information -->
    <div class="card p-6">
      <h2 class="text-lg font-semibold text-theme-text mb-4">Basic Information</h2>

      <% if @user.errors.any? %>
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-[15px] p-4 mb-4">
          <div class="flex items-center gap-2 text-red-800 dark:text-red-200 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="font-medium">Please fix the following errors:</span>
          </div>
          <ul class="list-disc list-inside text-sm text-red-700 dark:text-red-300">
            <% @user.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <%= f.label :first_name, class: "label" %>
          <%= f.text_field :first_name, class: "input", required: true %>
        </div>
        <div>
          <%= f.label :last_name, class: "label" %>
          <%= f.text_field :last_name, class: "input", required: true %>
        </div>
      </div>

      <div class="mt-4">
        <%= f.label :email, class: "label" %>
        <%= f.email_field :email, class: "input", required: true %>
      </div>
    </div>

    <!-- Contact Information -->
    <div class="card p-6">
      <h2 class="text-lg font-semibold text-theme-text mb-4">Contact Information</h2>

      <div class="space-y-4">
        <div>
          <%= f.label :phone, class: "label" %>
          <%= f.telephone_field :phone, class: "input", placeholder: "+1 (555) 000-0000" %>
          <p class="text-xs text-theme-secondary mt-1">Optional. Format: +1 (555) 000-0000</p>
        </div>

        <div>
          <%= f.label :address, class: "label" %>
          <%= f.text_area :address, class: "input", rows: 2, placeholder: "123 Main St, City, State, ZIP" %>
          <p class="text-xs text-theme-secondary mt-1">Optional. Your home address.</p>
        </div>

        <div>
          <%= f.label :birthday, class: "label" %>
          <%= f.date_field :birthday, class: "input" %>
          <p class="text-xs text-theme-secondary mt-1">Optional. Used for birthday reminders.</p>
        </div>
      </div>
    </div>

    <div class="flex justify-end gap-2">
      <%= link_to "Cancel", profile_path, class: "btn btn-secondary" %>
      <%= f.submit "Save Changes", class: "btn btn-primary" %>
    </div>
  <% end %>

  <!-- Change Password (Separate Form) -->
  <div class="card p-6 mt-6">
    <h2 class="text-lg font-semibold text-theme-text mb-4">Change Password</h2>
    <%= form_with url: update_password_profile_path, method: :patch, class: "space-y-4" do |f| %>
      <div>
        <%= f.label :current_password, class: "label" %>
        <%= f.password_field :current_password, class: "input", required: true, autocomplete: "current-password" %>
      </div>

      <div>
        <%= f.label :password, "New Password", class: "label" %>
        <%= f.password_field :password, class: "input", required: true, autocomplete: "new-password" %>
        <p class="text-xs text-theme-secondary mt-1">Minimum 8 characters.</p>
      </div>

      <div>
        <%= f.label :password_confirmation, class: "label" %>
        <%= f.password_field :password_confirmation, class: "input", required: true, autocomplete: "new-password" %>
      </div>

      <div class="flex justify-end">
        <%= f.submit "Change Password", class: "btn btn-secondary" %>
      </div>
    <% end %>
  </div>

  <!-- Theme Selection -->
  <div class="card p-6 mt-6">
    <h2 class="text-lg font-semibold text-theme-text mb-4">Theme</h2>
    <div class="flex items-center justify-between">
      <div>
        <p class="text-theme-text">Current theme: <strong><%= @user.effective_theme.name %></strong></p>
        <p class="text-sm text-theme-secondary"><%= @user.effective_theme.description %></p>
      </div>
      <div class="flex gap-2">
        <%= form_with url: update_theme_profile_path, method: :patch, class: "flex items-center gap-2" do |f| %>
          <%= f.select :theme_id,
                       Theme.active.order(:name).pluck(:name, :id),
                       { selected: @user.theme_id },
                       class: "input w-48" %>
          <%= f.submit "Apply", class: "btn btn-secondary" %>
        <% end %>
        <%= link_to "Browse Themes", theme_gallery_index_path, class: "btn btn-secondary" %>
      </div>
    </div>
  </div>

  <!-- Notification Preferences -->
  <div class="card p-6 mt-6">
    <h2 class="text-lg font-semibold text-theme-text mb-4">Notification Preferences</h2>
    <%= form_with url: update_notifications_profile_path, method: :patch, class: "space-y-4" do |f| %>
      <% User::NOTIFICATION_DEFAULTS.each do |key, default| %>
        <label class="flex items-center gap-3 cursor-pointer">
          <%= check_box_tag "notification_preferences[#{key}]",
                           "true",
                           @user.notification_enabled?(key),
                           class: "w-5 h-5 rounded border-theme-border text-theme-primary focus:ring-theme-primary" %>
          <div>
            <span class="text-theme-text font-medium"><%= key.titleize.gsub('_', ' ') %></span>
            <p class="text-sm text-theme-secondary">
              <%= case key
                  when 'event_reminders' then 'Receive notifications for upcoming events'
                  when 'event_rsvp_updates' then 'Get notified when someone RSVPs to your events'
                  when 'event_invitations' then 'Receive notifications for new event invitations'
                  else 'Enable this notification type'
                  end %>
            </p>
          </div>
        </label>
      <% end %>

      <div class="flex justify-end pt-4 border-t border-theme-border">
        <%= f.submit "Save Preferences", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>
